<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Shrunken Master | Motoki Wu</title>
	<meta name="description" content="">
	<meta name="author" content="Motoki Wu">
    <link rel="stylesheet" type="text/css" href="../theme/pygments-themes/tango.css" />
<!-- 
    <link rel="stylesheet" type="text/css" href="../theme/reset-fonts-grids.css" />
 -->
    <link rel="stylesheet" type="text/css" href="../theme/styles.css" />
  	<!-- <script type="text/javascript", src="../"></script> -->
	<!-- <script type="text/javascript" src="http://use.typekit.net/zfv6vnp.js"></script>
	<script type="text/javascript">try{Typekit.load();}catch(e){}</script> -->


		
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    imageFont: null,
    messageStyle: "none", 
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
          inlineMath: [ ['$','$'] ],
          displayMath: [ ['$$','$$'] ],
    processEscapes:true
    }
  });
</script>
<script type="text/javascript" src="https://d3eoax9i5htok0.cloudfront.net/mathjax/latest/MathJax.js"></script>
	
</head>

  <body><div id="MathJax_Message" style="display: none;"></div>
    <div class="wrapper">
      <div class="precontent">
        <div class="siteinfos">
          <h1><a href="../index.html"><span class="thl">Shrunken Master</span></a></h1>
          <div class="nav">
          <ul class="main-nav">
            <li><a href="../index.html">About</a></li>
            <li>|</li>
            <li><a href="../archives.html">Blog Archives</a></li>	
            <li>|</li>
          </ul>
        </div>
        </div>
      </div>

<section class="content">
			<div id="content">
    <div class="header">
        <h1><a href="../posts/my-second-article.html" style="color: black">My second article</a></h1>
    </div>
        
	<span class="margin">
	<small>
		<!-- <span><a href="../author/motoki-wu/">Motoki Wu</a></span><br /> -->
		<span>Wed 10 April 2013</span><br />
		<span class="tags"><a href="../tag/intro/">&#35;intro</a>, <a href="../tag/R Code/">&#35;R Code</a></span></small></span>
        <div class="entry-content"><div class="pbody">
        <p>This is the content of my super blog post.</p>
<p>$$
z = \sum_{k=1}^{|{\cal N}l|} \alpha{k}e^{-\frac{\left\| (x,y) - \mu_k(x,y) \right\|^2}{2{\sigma_k(x,y)^2} } }
$$</p>
<p><span class="margin">this is some margin</span></p>
<p>library(rjson)</p>
<div class="codehilite"><pre><span class="c1"># still need varying lags</span>
<span class="c1">## base delay diff operating model</span>
opmodel <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>pars<span class="p">,</span> m<span class="p">,</span> <span class="k-Variable">T</span><span class="p">,</span> E<span class="p">,</span> L<span class="p">,</span> phi0<span class="p">,</span> errR <span class="o">=</span> <span class="m">0</span><span class="p">,</span> errI <span class="o">=</span> <span class="m">0</span><span class="p">,</span> errN <span class="o">=</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
  beta <span class="o">&lt;-</span> pars<span class="p">$</span>beta        <span class="c1"># transformed steepness</span>
  mu <span class="o">&lt;-</span> pars<span class="p">$</span>mu          <span class="c1"># mean of transformed steepness</span>
  tau <span class="o">&lt;-</span> pars<span class="p">$</span>tau         <span class="c1"># sd of transformed steepness</span>
  B0 <span class="o">&lt;-</span> pars<span class="p">$</span>B0          <span class="c1"># unfished biomass</span>
  p <span class="o">&lt;-</span> pars<span class="p">$</span>p           <span class="c1"># growth coefficient</span>
  w <span class="o">&lt;-</span> pars<span class="p">$</span>w           <span class="c1"># w_k-1 / w_k</span>
  M <span class="o">&lt;-</span> pars<span class="p">$</span>M           <span class="c1"># natural mortality</span>
  sigR <span class="o">&lt;-</span> pars<span class="p">$</span>sigR        <span class="c1"># recruitment deviations</span>
  qI <span class="o">&lt;-</span> pars<span class="p">$</span>qI          <span class="c1"># prop coeff for abundance</span>
  sigI <span class="o">&lt;-</span> pars<span class="p">$</span>sigI       <span class="c1"># biomass observation errors</span>
  sigN <span class="o">&lt;-</span> pars<span class="p">$</span>sigN       <span class="c1"># recruitment observation errors</span>
  qN <span class="o">&lt;-</span> pars<span class="p">$</span>qN         <span class="c1"># prop coeff for recruitment</span>
  q <span class="o">&lt;-</span> pars<span class="p">$</span>q          <span class="c1"># catchability?</span>
  phiT <span class="o">&lt;-</span> pars<span class="p">$</span>phiT     <span class="c1"># autocorrelation on rec-devs</span>

  h <span class="o">&lt;-</span> <span class="p">(</span><span class="m">1</span><span class="o">+</span><span class="m">.2</span><span class="o">*</span>exp<span class="p">(</span><span class="o">-</span>beta<span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="m">1</span> <span class="o">+</span> exp<span class="p">(</span><span class="o">-</span>beta<span class="p">))</span>
  <span class="c1"># beta &lt;- log((h - 0.2) / (1 - h))</span>

<span class="c1">#  eps &lt;- matrix(rnorm((max(T)+1)*m,0,1), max(T)+1, m)</span>
<span class="c1"># eps[t] = eps[t-1]*phiT + sqrt(1+phiT^2)eta[t]</span>
  eps <span class="o">&lt;-</span> matrix<span class="p">(</span><span class="m">0</span><span class="p">,</span> max<span class="p">(</span><span class="k-Variable">T</span><span class="p">)</span><span class="o">+</span><span class="m">1</span><span class="p">,</span> m<span class="p">)</span>
  <span class="kr">for</span> <span class="p">(</span>k in <span class="m">1</span>:m<span class="p">)</span>
    eps<span class="p">[,</span>k<span class="p">]</span> <span class="o">&lt;-</span> arima.sim<span class="p">(</span>list<span class="p">(</span>ar <span class="o">=</span> phiT<span class="p">),</span> max<span class="p">(</span><span class="k-Variable">T</span><span class="p">)</span><span class="o">+</span><span class="m">1</span><span class="p">)</span>

  <span class="kr">if</span> <span class="p">(</span>length<span class="p">(</span>errR<span class="p">)</span> <span class="o">+</span> length<span class="p">(</span>errI<span class="p">)</span> <span class="o">+</span> length<span class="p">(</span>errN<span class="p">)</span> <span class="o">==</span> <span class="m">3</span><span class="p">)</span> <span class="p">{</span>
    errR <span class="o">&lt;-</span> exp<span class="p">(</span>eps<span class="o">*</span>sigR <span class="o">-</span> <span class="m">1</span><span class="o">*</span>sigR<span class="o">^</span><span class="m">2</span><span class="o">/</span><span class="m">2</span><span class="p">)</span>
    errI <span class="o">&lt;-</span> matrix<span class="p">(</span>exp<span class="p">(</span>rnorm<span class="p">((</span>max<span class="p">(</span><span class="k-Variable">T</span><span class="p">)</span><span class="o">+</span><span class="m">1</span><span class="p">)</span><span class="o">*</span>m<span class="p">,</span><span class="m">0</span><span class="p">,</span>sigI<span class="p">)</span> <span class="o">-</span> <span class="m">0</span><span class="o">*</span>sigI<span class="o">^</span><span class="m">2</span> <span class="o">/</span> <span class="m">2</span><span class="p">),</span> max<span class="p">(</span><span class="k-Variable">T</span><span class="p">)</span><span class="o">+</span><span class="m">1</span><span class="p">,</span> m<span class="p">)</span>
    errN <span class="o">&lt;-</span> matrix<span class="p">(</span>exp<span class="p">(</span>rnorm<span class="p">((</span>max<span class="p">(</span><span class="k-Variable">T</span><span class="p">)</span><span class="o">+</span><span class="m">1</span><span class="p">)</span><span class="o">*</span>m<span class="p">,</span><span class="m">0</span><span class="p">,</span>sigN<span class="p">)</span> <span class="o">-</span> <span class="m">0</span><span class="o">*</span>sigN<span class="o">^</span><span class="m">2</span> <span class="o">/</span> <span class="m">2</span><span class="p">),</span> max<span class="p">(</span><span class="k-Variable">T</span><span class="p">)</span><span class="o">+</span><span class="m">1</span><span class="p">,</span> m<span class="p">)</span>
  <span class="p">}</span>

  R0 <span class="o">&lt;-</span> B0 <span class="o">/</span> phi0
 <span class="c1"># print(q)</span>
  phi <span class="o">&lt;-</span> exp<span class="p">(</span><span class="o">-</span><span class="p">(</span>E <span class="o">%*%</span> diag<span class="p">(</span>q<span class="p">,</span> m<span class="p">,</span> m<span class="p">)))</span> <span class="c1"># matrix(exp(-q*E), T+1, m) # percent non-catch</span>

  B <span class="o">&lt;-</span> matrix<span class="p">(</span><span class="m">0</span><span class="p">,</span> max<span class="p">(</span><span class="k-Variable">T</span><span class="p">)</span><span class="o">+</span><span class="m">1</span><span class="p">,</span> m<span class="p">)</span>    <span class="c1"># spawning stock biomass</span>
  R <span class="o">&lt;-</span> matrix<span class="p">(</span><span class="m">0</span><span class="p">,</span> max<span class="p">(</span><span class="k-Variable">T</span><span class="p">)</span><span class="o">+</span><span class="m">1</span><span class="p">,</span> m<span class="p">)</span>    <span class="c1"># recruitment</span>
  C <span class="o">&lt;-</span> matrix<span class="p">(</span><span class="m">0</span><span class="p">,</span> max<span class="p">(</span><span class="k-Variable">T</span><span class="p">)</span><span class="o">+</span><span class="m">1</span><span class="p">,</span> m<span class="p">)</span>    <span class="c1"># catch</span>
  I <span class="o">&lt;-</span> matrix<span class="p">(</span><span class="m">0</span><span class="p">,</span> max<span class="p">(</span><span class="k-Variable">T</span><span class="p">)</span><span class="o">+</span><span class="m">1</span><span class="p">,</span> m<span class="p">)</span>    <span class="c1"># biomass index</span>
  N <span class="o">&lt;-</span> matrix<span class="p">(</span><span class="m">0</span><span class="p">,</span> max<span class="p">(</span><span class="k-Variable">T</span><span class="p">)</span><span class="o">+</span><span class="m">1</span><span class="p">,</span> m<span class="p">)</span>    <span class="c1"># recruitment index</span>

  <span class="c1"># first year</span>
  B<span class="p">[</span><span class="m">1</span><span class="p">,]</span> <span class="o">&lt;-</span> B0
  C<span class="p">[</span><span class="m">1</span><span class="p">,]</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="m">1</span> <span class="o">-</span> phi<span class="p">[</span><span class="m">1</span><span class="p">,])</span><span class="o">*</span>B<span class="p">[</span><span class="m">1</span><span class="p">,]</span>
  R<span class="p">[</span><span class="m">1</span><span class="p">,]</span> <span class="o">&lt;-</span> BH<span class="p">(</span>B<span class="p">[</span><span class="m">1</span><span class="p">,],</span>R0<span class="p">,</span>h<span class="p">,</span>phi0<span class="p">,</span>errR<span class="p">[</span><span class="m">1</span><span class="p">,])</span> <span class="c1"># R0</span>
  I<span class="p">[</span><span class="m">1</span><span class="p">,]</span> <span class="o">&lt;-</span> qI<span class="o">*</span>B<span class="p">[</span><span class="m">1</span><span class="p">,]</span><span class="o">*</span>errI<span class="p">[</span><span class="m">1</span><span class="p">,]</span> 
  N<span class="p">[</span><span class="m">1</span><span class="p">,]</span> <span class="o">&lt;-</span> qN<span class="o">*</span>R<span class="p">[</span><span class="m">1</span><span class="p">,]</span><span class="o">*</span>errN<span class="p">[</span><span class="m">1</span><span class="p">,]</span>

  <span class="c1"># second year  </span>
  R<span class="p">[</span><span class="m">2</span><span class="p">,]</span> <span class="o">&lt;-</span> BH<span class="p">(</span>B<span class="p">[</span><span class="m">1</span><span class="p">,],</span>R0<span class="p">,</span>h<span class="p">,</span>phi0<span class="p">,</span>errR<span class="p">[</span><span class="m">2</span><span class="p">,])</span> <span class="c1"># assume B_2-L = B_1-L </span>
  B<span class="p">[</span><span class="m">2</span><span class="p">,]</span> <span class="o">&lt;-</span> exp<span class="p">(</span><span class="o">-</span>M<span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="m">1</span> <span class="o">+</span> p <span class="o">-</span> p<span class="o">*</span>exp<span class="p">(</span><span class="o">-</span>M<span class="p">))</span><span class="o">*</span><span class="p">(</span>B<span class="p">[</span><span class="m">1</span><span class="p">,]</span> <span class="o">-</span> C<span class="p">[</span><span class="m">1</span><span class="p">,])</span> <span class="o">-</span>
    p<span class="o">*</span>w<span class="o">*</span>exp<span class="p">(</span><span class="o">-</span>M<span class="p">)</span> <span class="o">*</span> R<span class="p">[</span><span class="m">1</span><span class="p">,]</span> <span class="o">*</span> <span class="p">(</span>B<span class="p">[</span><span class="m">1</span><span class="p">,]</span> <span class="o">-</span> C<span class="p">[</span><span class="m">1</span><span class="p">,])</span><span class="o">/</span>B<span class="p">[</span><span class="m">1</span><span class="p">,]</span> <span class="o">+</span> R<span class="p">[</span><span class="m">2</span><span class="p">,]</span>

  C<span class="p">[</span><span class="m">2</span><span class="p">,]</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="m">1</span> <span class="o">-</span> phi<span class="p">[</span><span class="m">2</span><span class="p">,])</span> <span class="o">*</span> B<span class="p">[</span><span class="m">2</span><span class="p">,]</span>
  I<span class="p">[</span><span class="m">2</span><span class="p">,]</span> <span class="o">&lt;-</span> qI <span class="o">*</span> B<span class="p">[</span><span class="m">2</span><span class="p">,]</span> <span class="o">*</span> errI<span class="p">[</span><span class="m">2</span><span class="p">,]</span>
  N<span class="p">[</span><span class="m">2</span><span class="p">,]</span> <span class="o">&lt;-</span> qN <span class="o">*</span> R<span class="p">[</span><span class="m">2</span><span class="p">,]</span> <span class="o">*</span> errN<span class="p">[</span><span class="m">2</span><span class="p">,]</span>

  <span class="kr">for</span> <span class="p">(</span>k in <span class="m">1</span>:m<span class="p">)</span> <span class="p">{</span>
    <span class="kr">for</span> <span class="p">(</span>t in <span class="m">2</span>:<span class="k-Variable">T</span><span class="p">[</span>k<span class="p">])</span> <span class="p">{</span>
      R<span class="p">[</span>t<span class="o">+</span><span class="m">1</span><span class="p">,</span>k<span class="p">]</span> <span class="o">&lt;-</span> BH<span class="p">(</span>B<span class="p">[</span>ifelse<span class="p">(</span>t<span class="o">+</span><span class="m">1</span><span class="o">-</span>L <span class="o">&lt;</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> t<span class="o">+</span><span class="m">1</span><span class="o">-</span>L<span class="p">),</span>k<span class="p">],</span>
                     R0<span class="p">[</span>k<span class="p">],</span>h<span class="p">[</span>k<span class="p">],</span>phi0<span class="p">[</span>k<span class="p">],</span>errR<span class="p">[</span>t<span class="o">+</span><span class="m">1</span><span class="p">,</span>k<span class="p">])</span>
      B<span class="p">[</span>t<span class="o">+</span><span class="m">1</span><span class="p">,</span>k<span class="p">]</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="m">1</span><span class="o">+</span>p<span class="p">[</span>k<span class="p">])</span><span class="o">*</span>exp<span class="p">(</span><span class="o">-</span>M<span class="p">[</span>k<span class="p">])</span><span class="o">*</span><span class="p">(</span>B<span class="p">[</span>t<span class="p">,</span>k<span class="p">]</span> <span class="o">-</span> C<span class="p">[</span>t<span class="p">,</span>k<span class="p">])</span> <span class="o">-</span>
        p<span class="p">[</span>k<span class="p">]</span><span class="o">*</span>exp<span class="p">(</span><span class="m">-2</span><span class="o">*</span>M<span class="p">[</span>k<span class="p">])</span><span class="o">*</span><span class="p">(</span>B<span class="p">[</span>t<span class="p">,</span>k<span class="p">]</span> <span class="o">-</span> C<span class="p">[</span>t<span class="p">,</span>k<span class="p">])</span> <span class="o">/</span> B<span class="p">[</span>t<span class="p">,</span>k<span class="p">]</span> <span class="o">*</span> <span class="p">(</span>B<span class="p">[</span>t<span class="o">-</span><span class="m">1</span><span class="p">,</span>k<span class="p">]</span> <span class="o">-</span> C<span class="p">[</span>t<span class="o">-</span><span class="m">1</span><span class="p">,</span>k<span class="p">])</span> <span class="o">-</span>
          p<span class="p">[</span>k<span class="p">]</span><span class="o">*</span>w<span class="p">[</span>k<span class="p">]</span><span class="o">*</span>exp<span class="p">(</span><span class="o">-</span>M<span class="p">[</span>k<span class="p">])</span><span class="o">*</span><span class="p">(</span>B<span class="p">[</span>t<span class="p">,</span>k<span class="p">]</span> <span class="o">-</span> C<span class="p">[</span>t<span class="p">,</span>k<span class="p">])</span> <span class="o">/</span> B<span class="p">[</span>t<span class="p">,</span>k<span class="p">]</span> <span class="o">*</span> R<span class="p">[</span>t<span class="p">,</span>k<span class="p">]</span> <span class="o">+</span> R<span class="p">[</span>t<span class="o">+</span><span class="m">1</span><span class="p">,</span>k<span class="p">]</span>
      C<span class="p">[</span>t<span class="o">+</span><span class="m">1</span><span class="p">,</span>k<span class="p">]</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="m">1</span> <span class="o">-</span> phi<span class="p">[</span>t<span class="o">+</span><span class="m">1</span><span class="p">,</span>k<span class="p">])</span><span class="o">*</span>B<span class="p">[</span>t<span class="o">+</span><span class="m">1</span><span class="p">,</span>k<span class="p">]</span>
      I<span class="p">[</span>t<span class="o">+</span><span class="m">1</span><span class="p">,</span>k<span class="p">]</span> <span class="o">&lt;-</span> qI <span class="o">*</span> B<span class="p">[</span>t<span class="o">+</span><span class="m">1</span><span class="p">,</span>k<span class="p">]</span> <span class="o">*</span> errI<span class="p">[</span>t<span class="o">+</span><span class="m">1</span><span class="p">,</span>k<span class="p">]</span>
      N<span class="p">[</span>t<span class="o">+</span><span class="m">1</span><span class="p">,</span>k<span class="p">]</span> <span class="o">&lt;-</span> qN <span class="o">*</span> R<span class="p">[</span>t<span class="o">+</span><span class="m">1</span><span class="p">,</span>k<span class="p">]</span> <span class="o">*</span> errN<span class="p">[</span>t<span class="o">+</span><span class="m">1</span><span class="p">,</span>k<span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>

  list<span class="p">(</span>B <span class="o">=</span> B<span class="p">,</span> I <span class="o">=</span> I<span class="p">,</span> C <span class="o">=</span> C<span class="p">,</span> R <span class="o">=</span> R<span class="p">,</span> N <span class="o">=</span> N<span class="p">,</span> E <span class="o">=</span> E<span class="p">,</span> mu <span class="o">=</span> mu<span class="p">,</span> tau <span class="o">=</span> tau<span class="p">,</span>
       p <span class="o">=</span> p<span class="p">,</span> w <span class="o">=</span> w<span class="p">,</span> M <span class="o">=</span> M<span class="p">,</span> phiT <span class="o">=</span> phiT<span class="p">,</span>
       h <span class="o">=</span> h<span class="p">,</span> beta <span class="o">=</span> beta<span class="p">,</span> phi <span class="o">=</span> phi<span class="p">,</span> <span class="k-Variable">T</span><span class="o">=</span><span class="k-Variable">T</span><span class="p">,</span> L<span class="o">=</span>L<span class="p">,</span> qI <span class="o">=</span> qI<span class="p">,</span> qN <span class="o">=</span> qN<span class="p">,</span> m<span class="o">=</span>m<span class="p">,</span>
       q <span class="o">=</span> q<span class="p">,</span> B0 <span class="o">=</span> B0<span class="p">,</span> R0 <span class="o">=</span> R0<span class="p">,</span> phi0 <span class="o">=</span> phi0<span class="p">,</span> eps <span class="o">=</span> eps<span class="p">,</span>
       errR <span class="o">=</span> errR<span class="p">,</span> errI <span class="o">=</span> errI<span class="p">,</span> errN <span class="o">=</span> errN<span class="p">,</span>
       sigR <span class="o">=</span> sigR<span class="p">,</span> sigI <span class="o">=</span> sigI<span class="p">,</span> sigN <span class="o">=</span> sigN<span class="p">)</span>
<span class="p">}</span>

<span class="c1">## stock recruitment function</span>
BH <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>B<span class="p">,</span> R0<span class="p">,</span> h<span class="p">,</span> phi0<span class="p">,</span> err<span class="p">)</span> <span class="p">{</span>
  R <span class="o">&lt;-</span> <span class="m">0.8</span><span class="o">*</span>R0<span class="o">*</span>h<span class="o">*</span>B <span class="o">/</span> <span class="p">(</span><span class="m">0.2</span><span class="o">*</span>phi0<span class="o">*</span>R0<span class="o">*</span><span class="p">(</span><span class="m">1</span><span class="o">-</span>h<span class="p">)</span> <span class="o">+</span> <span class="p">(</span>h<span class="o">-</span><span class="m">0.2</span><span class="p">)</span><span class="o">*</span>B<span class="p">)</span>
  as.matrix<span class="p">(</span>R <span class="o">*</span> err<span class="p">)</span>
<span class="p">}</span>

<span class="c1">## stagger the B and R data for meta-analysis</span>
stagger <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>L<span class="p">,</span> <span class="k-Variable">T</span><span class="p">,</span> m<span class="p">,</span> B<span class="p">,</span> R<span class="p">)</span> <span class="p">{</span>
  B.stag <span class="o">&lt;-</span> matrix<span class="p">(</span><span class="m">0</span><span class="p">,</span> dim<span class="p">(</span>B<span class="p">)[</span><span class="m">1</span><span class="p">]</span><span class="o">-</span>L<span class="p">,</span> dim<span class="p">(</span>B<span class="p">)[</span><span class="m">2</span><span class="p">])</span>
  R.stag <span class="o">&lt;-</span> matrix<span class="p">(</span><span class="m">0</span><span class="p">,</span> dim<span class="p">(</span>R<span class="p">)[</span><span class="m">1</span><span class="p">]</span><span class="o">-</span>L<span class="p">,</span> dim<span class="p">(</span>R<span class="p">)[</span><span class="m">2</span><span class="p">])</span>
  <span class="kr">for</span> <span class="p">(</span>k in <span class="m">1</span>:m<span class="p">)</span> <span class="p">{</span>
    B.stag<span class="p">[</span><span class="m">1</span>:<span class="p">(</span><span class="k-Variable">T</span><span class="p">[</span>k<span class="p">]</span><span class="o">+</span><span class="m">1</span><span class="o">-</span>L<span class="p">),</span>k<span class="p">]</span> <span class="o">&lt;-</span> B<span class="p">[</span><span class="m">1</span>:<span class="p">(</span><span class="k-Variable">T</span><span class="p">[</span>k<span class="p">]</span><span class="o">+</span><span class="m">1</span><span class="o">-</span>L<span class="p">),</span>k<span class="p">]</span>
    R.stag<span class="p">[(</span><span class="m">1</span><span class="p">)</span>:<span class="p">(</span><span class="k-Variable">T</span><span class="p">[</span>k<span class="p">]</span><span class="o">+</span><span class="m">1</span><span class="o">-</span>L<span class="p">),</span>k<span class="p">]</span> <span class="o">&lt;-</span> R<span class="p">[(</span>L<span class="o">+</span><span class="m">1</span><span class="p">)</span>:<span class="p">(</span><span class="k-Variable">T</span><span class="p">[</span>k<span class="p">]</span><span class="o">+</span><span class="m">1</span><span class="p">),</span>k<span class="p">]</span>
  <span class="p">}</span>
  list<span class="p">(</span>B <span class="o">=</span> B.stag<span class="p">,</span> R <span class="o">=</span> R.stag<span class="p">)</span>
<span class="p">}</span>

<span class="c1">## wrapper for running the operating model just for one stock</span>
opmodel.sing <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>k<span class="p">,</span> pars<span class="p">,</span> m<span class="p">,</span> <span class="k-Variable">T</span><span class="p">,</span> E<span class="p">,</span> L<span class="p">,</span> phi0<span class="p">,</span> errR<span class="p">,</span> errI<span class="p">,</span> errN<span class="p">)</span> <span class="p">{</span>
  pars.k <span class="o">&lt;-</span> with<span class="p">(</span>pars<span class="p">,</span> list<span class="p">(</span>beta<span class="o">=</span>beta<span class="p">[</span>k<span class="p">],</span> mu<span class="o">=</span>mu<span class="p">,</span> tau<span class="o">=</span>tau<span class="p">,</span> B0<span class="o">=</span>B0<span class="p">[</span>k<span class="p">],</span> p<span class="o">=</span>p<span class="p">[</span>k<span class="p">],</span> w<span class="o">=</span>w<span class="p">[</span>k<span class="p">],</span> M<span class="o">=</span>M<span class="p">[</span>k<span class="p">],</span>
                            sigR<span class="o">=</span>sigR<span class="p">,</span> qI<span class="o">=</span>qI<span class="p">,</span> sigI<span class="o">=</span>sigI<span class="p">,</span> sigN<span class="o">=</span>sigN<span class="p">,</span> qN<span class="o">=</span>qN<span class="p">,</span> q<span class="o">=</span>q<span class="p">[</span>k<span class="p">]))</span>
  m.k <span class="o">&lt;-</span> <span class="m">1</span>
  <span class="k-Variable">T</span><span class="m">.</span>k <span class="o">&lt;-</span> <span class="k-Variable">T</span>
  E.k <span class="o">&lt;-</span> t<span class="p">(</span>t<span class="p">(</span>E<span class="p">[,</span>k<span class="p">]))</span>
  L.k <span class="o">&lt;-</span> L <span class="c1"># still needs changing</span>
  phi0.k <span class="o">&lt;-</span> phi0<span class="p">[</span>k<span class="p">]</span>
  errR.k <span class="o">&lt;-</span> t<span class="p">(</span>t<span class="p">(</span>errR<span class="p">[,</span>k<span class="p">]))</span>
  errI.k <span class="o">&lt;-</span> t<span class="p">(</span>t<span class="p">(</span>errI<span class="p">[,</span>k<span class="p">]))</span>
  errN.k <span class="o">&lt;-</span> t<span class="p">(</span>t<span class="p">(</span>errN<span class="p">[,</span>k<span class="p">]))</span>
<span class="c1">#  print(paste(&quot;sing&quot;, pars.k$q))</span>
  opmodel<span class="p">(</span>pars.k<span class="p">,</span> m.k<span class="p">,</span> <span class="k-Variable">T</span><span class="m">.</span>k<span class="p">,</span> E.k<span class="p">,</span> L.k<span class="p">,</span> phi0.k<span class="p">,</span> errR.k<span class="p">,</span> errI.k<span class="p">,</span> errN.k<span class="p">)</span>
<span class="p">}</span>

<span class="c1">## wrapper for finding the right q</span>
opmodel.dep <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>q.dep<span class="p">,</span> T_dep<span class="p">,</span> dep<span class="p">,</span> k<span class="p">,</span> pars<span class="p">,</span> m<span class="p">,</span> <span class="k-Variable">T</span><span class="p">,</span> E<span class="p">,</span> L<span class="p">,</span> phi0<span class="p">,</span>
                        errR<span class="p">,</span> errI<span class="p">,</span> errN<span class="p">)</span> <span class="p">{</span>
  pars<span class="p">$</span>q <span class="o">&lt;-</span> q.dep
  out <span class="o">&lt;-</span> opmodel<span class="p">(</span>pars<span class="p">,</span> m<span class="p">,</span> <span class="k-Variable">T</span><span class="p">,</span> E<span class="p">,</span> L<span class="p">,</span> phi0<span class="p">,</span> errR<span class="p">,</span> errI<span class="p">,</span> errN<span class="p">)</span>
  <span class="p">(</span>out<span class="p">$</span>B<span class="p">[</span>T_dep<span class="p">]</span> <span class="o">-</span> out<span class="p">$</span>B0<span class="o">*</span>dep<span class="p">)</span><span class="o">^</span><span class="m">2</span>
<span class="p">}</span>

<span class="c1">## wrapper for finding perfect q</span>
opmodel.pq <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>q.dep<span class="p">,</span> k<span class="p">,</span> T_dep<span class="p">,</span> dep<span class="p">,</span> pars<span class="p">,</span> m<span class="p">,</span> <span class="k-Variable">T</span><span class="p">,</span> E<span class="p">,</span> L<span class="p">,</span> phi0<span class="p">,</span>
                       errR<span class="p">,</span> errI<span class="p">,</span> errN<span class="p">)</span> <span class="p">{</span>
  out <span class="o">&lt;-</span> opmodel.sing<span class="p">(</span>k<span class="p">,</span> pars<span class="p">,</span> m<span class="p">,</span> <span class="k-Variable">T</span><span class="p">,</span> E<span class="p">,</span> L<span class="p">,</span> phi0<span class="p">,</span> errR<span class="p">,</span> errI<span class="p">,</span> errN<span class="p">)</span>
  <span class="p">(</span>out<span class="p">$</span>B<span class="p">[</span>T_dep<span class="p">]</span> <span class="o">-</span> out<span class="p">$</span>B0<span class="o">*</span>dep<span class="p">)</span><span class="o">^</span><span class="m">2</span>
<span class="p">}</span>

<span class="c1">## h -&gt; beta</span>
h_to_beta <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>h<span class="p">)</span>
  log<span class="p">((</span>h <span class="o">-</span> <span class="m">.2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="m">1</span> <span class="o">-</span> h<span class="p">))</span>

<span class="c1">## beta -&gt; h</span>
beta_to_h <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>beta<span class="p">)</span>
  <span class="p">(</span>exp<span class="p">(</span>beta<span class="p">)</span> <span class="o">+</span> <span class="m">.2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="m">1</span> <span class="o">+</span> exp<span class="p">(</span>beta<span class="p">))</span>

<span class="c1">## dnorm for h</span>
beta_to_h.dnorm <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>h<span class="p">,</span> mu<span class="p">,</span> sigma<span class="p">)</span> <span class="p">{</span>
<span class="c1">#  h &lt;- (exp(beta) + .2) / (1 + exp(beta))</span>
  beta <span class="o">&lt;-</span> log<span class="p">((</span>h <span class="o">-</span> <span class="m">.2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="m">1</span> <span class="o">-</span> h<span class="p">))</span>
  <span class="p">(</span><span class="m">1</span><span class="o">/</span><span class="p">(</span>h<span class="o">-</span><span class="m">.2</span><span class="p">)</span> <span class="o">+</span> <span class="m">1</span><span class="o">/</span><span class="p">(</span><span class="m">1</span><span class="o">-</span>h<span class="p">))</span> <span class="o">*</span> <span class="m">1</span> <span class="o">/</span> sqrt<span class="p">(</span><span class="m">2</span><span class="o">*</span>pi<span class="o">*</span>sigma<span class="o">^</span><span class="m">2</span><span class="p">)</span> <span class="o">*</span> exp<span class="p">(</span><span class="o">-</span><span class="p">(</span>beta <span class="o">-</span> mu<span class="p">)</span><span class="o">^</span><span class="m">2</span> <span class="o">/</span> <span class="p">(</span><span class="m">2</span><span class="o">*</span>sigma<span class="o">^</span><span class="m">2</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">## calculate 95% confidence intervals for steepness (h)</span>
h_profCI <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>h_search<span class="p">,</span> h_obj<span class="p">,</span> h_prof<span class="p">,</span> y<span class="p">)</span> <span class="p">{</span>
  h_spline <span class="o">&lt;-</span> splinefun<span class="p">(</span>h_prof<span class="p">,</span> y<span class="p">,</span> method <span class="o">=</span> <span class="s">&quot;natural&quot;</span><span class="p">)</span>
  <span class="p">((</span>h_obj <span class="o">+</span> <span class="m">1.3527</span><span class="p">)</span> <span class="o">-</span> h_spline<span class="p">(</span>h_search<span class="p">))</span><span class="o">^</span><span class="m">2</span>
<span class="p">}</span>

<span class="c1">## calculate 95% confidence intervals for steepness (beta)</span>
beta_profCI <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>beta_search<span class="p">,</span> h_obj<span class="p">,</span> beta_prof<span class="p">,</span> y<span class="p">)</span> <span class="p">{</span>
  beta_spline <span class="o">&lt;-</span> splinefun<span class="p">(</span>beta_prof<span class="p">,</span> y<span class="p">,</span> method <span class="o">=</span> <span class="s">&quot;natural&quot;</span><span class="p">)</span>
  <span class="p">((</span>h_obj <span class="o">+</span> <span class="m">1.3527</span><span class="p">)</span> <span class="o">-</span> beta_spline<span class="p">(</span>beta_search<span class="p">))</span><span class="o">^</span><span class="m">2</span>
<span class="p">}</span>
</pre></div>
        </div>
        </div><!-- /.entry-content -->
        
        
                

</div>
</section>
      <div class="footer">
		  <p> Powered by <a href="http://alexis.notmyidea.org/pelican/">Pelican</a>.</p>

      </div>
      
    </div>
    <!--[if !IE]><script>fixScale(document);</script><!--<![endif]-->
  


</body></html>